# generator-skidki2

Позже пришла идея, что лучше заранее создать набор правил (1-50%%) без срока действия, а уже их рандомно выбирать и генерировать купоны пользователям с сроками. 
demo-data.php создает набор правил которым прописывается специфический xml_id по которому идет выборка + тестовые юзеры (10). Описание полей внутри.

# generator-skidki
Генератор скидки Bitrix через систему купонов

Функционал генерации скидки основан на двух элементах: правила корзины, купоны.

На странице есть кнопка генерации и поле + кнопка для проверки кода. Работают через ajax с библиотекой jq. 

Проверка авторизации как на странице генерации так и в скрипте php.

Рандом выбираем размер скидки из целого числа 1-50. Фиксируем время старта и конца действия. Создаем правило корзины, на его основе создаем купон задавай 3-х часовой лимит и владельца купона. 

Если пользователь нажал кнопку генерации и срок действия купона не истек, то выводится тот же код купона. Не понятно почему указано в течении часа если срок действия 3ч. 

Если принципиально важно 1ч, то можно получить все активные купоны, а из них проверить удовлетворяющий условию и вывести если такой есть в противном случае создать еще.
Проверка купона идет по коду купона, проверяем срок действия и владельца если срок купона не прошел и пользователь владелец, то выводим размер скидки иначе сообщение об ошибке.

Непонятно зачем дополнительно хранить значение кода и скидки для каждого пользователя в отдельном месте, если все связи есть - купон (юзер id + код скидки + id правила), правило – размер скидки. Если описанное выше не подходит, то для стандартного визуала можно в инфоблок писать, если для специфических целей, то можно создать отдельную таблицу БД.
